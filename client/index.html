<!DOCTYPE html>
<html lang="en">
<head>
	<style>
		canvas {
			background-color: white;
			padding: 0;
			margin: auto;
			display: block;
			width: 800px;
		}
		
		body{
			background-color: black;
		}
		
		h1{
			color: white;
		}
	</style>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        "use strict";
    
        var canvas;
        var ctx;
		var text;
		var speed;
		var up,down,left,right;
		
		//User data
		var user = 'user' + (Math.floor((Math.random()*1000)) + 1);
		var draws = {};

        //our websocket connection
        var socket; 
        
        //redraw our square to the screen
        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
			
			var keys = Object.keys(draws);
			
			for(var i = 0; i < keys.length; i++)
			{
				var drawCall = draws[ keys[i] ];
				//Create gradient
				/*var gradient=ctx.createLinearGradient(drawCall.x,drawCall.y,drawCall.x+50,drawCall.y+50);
				gradient.addColorStop("0","magenta");
				gradient.addColorStop("0.5","blue");
				gradient.addColorStop("1.0","red");*/
				
				//Fill with drawCall.color
				//ctx.strokeStyle = gradient;
				ctx.strokeStyle = drawCall.color;
				ctx.lineWidth = 3;
				ctx.strokeRect(drawCall.x, drawCall.y, drawCall.width, drawCall.height);
			}
			
        }
        

        function init() {
            canvas = document.querySelector("#canvas");
            ctx = canvas.getContext("2d");
			//text = document.querySelector("#pointText");
			
			//Movement variables
			speed = 2.5;
			up = false;
			down = false;
			right = false;
			left = false;
			
			//Give an init position
			var x = 200;
			var y = 200;
			
			//SetCall function
			function moveCalls(){
				//Click coords
				if(up){y = y - speed;}
				if(down){y = y + speed;}
				if(left){x = x - speed;}
				else if(right){x = x + speed;}
				
				//Update draws array
				var time = new Date().getTime();
				draws[user].lastUpdate = time;
				draws[user].x = x;
				draws[user].y = y;
				
				//Emit
				socket.emit('mover', { name: user, coords: draws[user] });
			}
			
			function setUp(){
				var time = new Date().getTime();
				draws[user] = {lastUpdate: time, x: x, y: y, width: 50, height: 50, color: "black"};
			}
			
			//HandleMessage function
			function handleMessage(data)
			{	
				//If draws at index data.name is null add data, else update data
				if( !draws[data.name] )
				{
					draws[data.name] = {lastUpdate: data.lastUpdate, x: data.x, y: data.y, width: 50, height: 50, color: "red"};
				}
				else
				{
					draws[data.name].x = data.x;
					draws[data.name].y = data.y;
				}


				redraw();
			}
			
	
			document.addEventListener('keydown', function(event) {			
				//if "W" or Up Arrow was pressed
				if(event.keyCode == 87 || event.keyCode == 38) {up = true;}
				//if "A" or Left Arrow was pressed
				if(event.keyCode == 65 || event.keyCode == 37) {left = true;}
				//if "S" or Down Arrow was pressed
				if(event.keyCode == 83 || event.keyCode == 40) {down = true;}
				//if "D" or Right Arrow was pressed
				if(event.keyCode == 68 || event.keyCode == 39) {right = true;}
				
				moveCalls();
				
			});
			
			document.addEventListener('keyup', function(event) {
				//if "W" or Up Arrow was pressed
				if(event.keyCode == 87 || event.keyCode == 38) {up = false;}
				//if "A" or Left Arrow was pressed
				if(event.keyCode == 65 || event.keyCode == 37) {left = false;}
				//if "S" or Down Arrow was pressed
				if(event.keyCode == 83 || event.keyCode == 40) {down = false;}
				//if "D" or Right Arrow was pressed
				if(event.keyCode == 68 || event.keyCode == 39) {right = false;}
				
				moveCalls();
			});

        
            //Connect to our server (io added automatically by socket.io when embedding it in the HTTP app on the server side)
            //This will return a new websocket connection. Every call to io.connect will return a new websocket connection 
            //BUT not necessarily close the existing one. 
            //You can absolutely use multiple websockets on the client, but you have to manage which ones are listening to which
            //messages. In cases like this, you only need one. 
            socket = io.connect();
			
			
			
            //When the socket connects successfully
            socket.on('connect', function () {
				//Setup the first time user connects, also draw
				setUp();
				redraw();
				
				//Emit
				socket.emit('mover', { name: user, coords: draws[user] });
            });      
            
            //When our socket receives 'moveCharacter' messages from the server, call our handleMessage function
			socket.on('moveCharacter',handleMessage);
			
			
			
			//Get mouse position
			/*canvas.addEventListener('click', function(evt) {
				var mousePos = getMousePos(canvas, evt);
				x = mousePos.x;
				y = mousePos.y;
				
				setCalls();
				
			}, false);
			
			function getMousePos(canvas, evt) {
				var rect = canvas.getBoundingClientRect();
				return {
				  x: evt.clientX - rect.left,
				  y: evt.clientY - rect.top
				};
			}*/
			
        }

      window.onload = init;
    </script>
</head>
<body>
	<h1 id="title" align="center">Jared's Game</h1>
    <canvas id="canvas" height="500" width="500" style= "border:1px solid black">Please use an HTML 5 browser</canvas
</body>
</html>